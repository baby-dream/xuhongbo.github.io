<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> ❤️❤️Emoji💋💋在前端的处理办法以及字符编码 · xuhongbo</title><meta name="description" content="❤️❤️Emoji💋💋在前端的处理办法以及字符编码 - xuhongbo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://xuhongbo.com/atom.xml" title="xuhongbo"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">文章列表</a></li><li class="nav-list-item"><a href="https://github.com/xuhongbo" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/abstract/" target="_self" class="nav-list-link">个人简介</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">❤️❤️Emoji💋💋在前端的处理办法以及字符编码</h1><div class="post-info">Apr 14, 2017</div><div class="post-content"><p>​     为什么会有题目中的❤️Emoji💋的过滤呢，主要是因为❤️Emoji💋的字符编码所决定的。下面就先说一下字符编码问题。字符编码是计算机原理中一个很重要的一环，然而它里面有很多概念容易混淆，本文就来结合 ❤️Emoji💋 谈谈 Unicode 和它的实现方案们。</p>
<a id="more"></a>
<h2 id="当我们谈论-Unicode-时，我们在说什么？"><a href="#当我们谈论-Unicode-时，我们在说什么？" class="headerlink" title="当我们谈论 Unicode 时，我们在说什么？"></a>当我们谈论 Unicode 时，我们在说什么？</h2><p>字符编码有很多国际标准，例如 ASCII、ANSI（包括 GBK）、Unicode，这些不同的编码方式说白了就是一个 HashMap（严格来讲应该是一个稀疏数组，因为数字本身不涉及 Hash 和碰撞的问题），K 就是编码，V 就是对应的单个字符。众所周知，ASCII 编码根本不能包含国际上所有的字符，因为它 K 的取值还不过 8 bits。ANSI、ASCII 不在我们今天的讨论范围内。</p>
<p>下面我们说说 Unicode。</p>
<p>可以说，Unicode 几乎可以覆盖国际上所有的文字了，它是一张巨大的表，K 的范围从 0x0 - 0x10FFFF，理论上能容纳 <a href="tel:1114112" target="_blank" rel="external">1114112</a> 个字符，已经上百万的数量级了。所以只要一个文本采用 Unicode 编码，那么它的每个字符的编码都应该落在这 0x0 - 0x10FFFF 的区间内了，并且一一对应。</p>
<p>由于 Unicode 太庞大了，因此人们用 Plane（平面）的概念来给这些编码划分区间，这个概念大家可以自行查询，后面我会继续提到它。</p>
<h2 id="所以-UTF-x-都是什么？"><a href="#所以-UTF-x-都是什么？" class="headerlink" title="所以 UTF-x 都是什么？"></a>所以 UTF-x 都是什么？</h2><p>我们通常说的 UTF-8、UTF-16 亦或是 UTF-32 是 Unicode 这种编码在计算机中的存储方式。</p>
<p>我们可以看到，Unicode 中最大的取值是 0x10FFFF，占 3 个字节，那么这些字节如何存储就是一个问题了。</p>
<p><strong>UTF-16</strong></p>
<p>通常我们说 Unicode 编码的时候，其实是在说 UTF-16。Windows 内核、Java、Objective-C (Foundation)、JavaScript 中都会将字符的基本单元定为两个字节的数据类型，也就是我们在 C / C++ 中遇到的 <strong>wchar_t</strong> 类型或 Java 中的 <strong>char</strong> 类型等等，这些类型占内存两个字节，因为 Unicode 中常用的字符都处于 0x0 - 0xFFFF 的范围之内，因此两个字节几乎可以覆盖大部分的常用字符。</p>
<p>然而我们总需要用到一些不常用的字符，就比如 ❤️Emoji💋。这些字符落在一个名为 Astral 的平面内，总之是超过了 0xFFFF，那么我们如何用两个字节来表示呢？这里肯定不能用两个字节表示了。所以 UTF-16 做了这个的规定：</p>
<p>高位字节为 0b110110 或 0b110111 的字元需要两两配对共同表达一个处于 0x10000 - 0x10FFFF 的字符。</p>
<p>0x10000 - 0x10FFFF 之间有 0xFFFFF 个字符，20 bits。0xD800 和 0xDC00 都有 10 bits 以上的空余空间，所以我们可以将超过 0xFFFF 的编码减掉 0x10000，将结果的 20 bits 中的前 10 bits 与 0xD800 做 OR 运算，将后 10 bits 与 0xDC00 做 OR 运算。这样，解析的时候如果高位字节是 0b110110，那么取其低位 10 bits，存起来，再读取下一个字元，取其低位 10 bits，两个结合起来再加上 0x10000 就能还原出来响应的编码了。</p>
<p>说得比较干涩，举个🌰：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&apos;😂&apos;.charCodeAt(0) // 55357</div><div class="line">&apos;😂&apos;.charCodeAt(1) // 56834</div></pre></td></tr></table></figure>
<p>55357 二进制 <a href="tel:1101%201000%200011%201101" target="_blank" rel="external">1101 1000 0011 1101</a>，高位有 0b110110，剩下的 10 个低位是 0b0000111101。</p>
<p>56834 二进制 <a href="tel:1101%201110%200000%200010" target="_blank" rel="external">1101 1110 0000 0010</a>，高位有 0b110111，剩下的 10 个低位是 0b1000000010。</p>
<p>两个合在一起再加 0x10000 = 0x1F602，正好是 😂 这个表情的 Unicode 编码。</p>
<p>到这里你应该能理解 UTF-16 了吧。</p>
<p><strong>UTF-8</strong></p>
<p>这里简单提一下，详细的大家可以自己查。</p>
<p>UTF-8 巧妙借助了一个字节内的高位作为标志位，动态调整一个字元的长度。</p>
<p>最高位为 0，这表示这个字元占一个字节，编码为剩余的 7 bits。</p>
<p>最高位为 0b110，代表这个字元占两个字节，接下来的字节高位均为 0b10，要取剩余的 6 bits。</p>
<p>以此类推…</p>
<p><strong>UTF-32</strong></p>
<p>这个比较简单了，就是暴力且奢侈地用 4 个字节来直接存储所有的编码。</p>
<p>其实别看 UTF-32 这么不中用，其实用它来统计文字个数是非常简单的。😂用 UTF-16 表示为两个字节，用 UTF-8 表示是四个字节，因此对于 Foundation 中的 NSString、JavaScript 中的原生 String 等采用 UTF-16 存储文字的容器，😂的 length 就是 2，显然是不正确的，但假如你把它转换成 UTF-32，length 除以 4 就是 1 了。但是编码转换还是有一定开销的，其实结合上面说到的，我们完全可以自己写一个 walker 来精确统计一个固定编码下的字符个数到底是多少个，相信大家不难实现。</p>
<p>事实上，Swift 中的 CharacterView 就隐藏了编码细节，将字符作为基本单元，这样当你调用其 count 属性时，返回的就是我们所看到的字符的个数。</p>
<h2 id="❤️Emoji💋-好像有点复杂"><a href="#❤️Emoji💋-好像有点复杂" class="headerlink" title="❤️Emoji💋 好像有点复杂"></a>❤️Emoji💋 好像有点复杂</h2><p>事实上 Swift 做了更多。</p>
<p>很多 ❤️Emoji💋 其实不是一个 Unicode 字元能表示的，比如 ❤️，这玩意就算转换成了 UTF-32 也占 8 个字节，除以 4 是 2，两个字符？？❤️ 其实是由 ❤ 和一个样式控制符组成的，当文字渲染引擎读到这样的字符组合时就会去 ❤️Emoji💋 字体库找 ❤️来渲染，所以对于这类 ❤️Emoji💋 处理起来也要特殊考虑。</p>
<p>还有更变态的是 👩❤️💋👩，这货是 6 个字符组成的，里面用到了零宽字符将几个表情连接起来，最后就能作为一个字符渲染了。</p>
<h2 id="❤️Emoji💋-filter"><a href="#❤️Emoji💋-filter" class="headerlink" title="❤️Emoji💋 filter"></a>❤️Emoji💋 filter</h2><p>话不多说，直接上代码</p>
<p>先说一下大体的思路就是根据新输入的字符进行字节的判断进行过滤，还有就是根据特征进行正则匹配</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">"lwoaApp"</span>)</div><div class="line">    .directive(<span class="string">"utf16toEntities"</span>, [<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> &#123;</div><div class="line">          	<span class="comment">//这里进行匹配模式这里用到A（默认）可以不写</span></div><div class="line">          	restrict: <span class="string">"A"</span>,</div><div class="line">            <span class="attr">require</span>: <span class="string">'?^ngModel'</span>,<span class="comment">//这里进行替换操作</span></div><div class="line">            link: <span class="function"><span class="keyword">function</span> (<span class="params">scope, elem, attrs, ngmodel</span>) </span>&#123;</div><div class="line">                <span class="keyword">var</span> startLen = <span class="number">0</span>;<span class="comment">//初始化字符串长度</span></div><div class="line">                elem.on(<span class="string">'input'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;<span class="comment">//添加输入事件</span></div><div class="line">                    <span class="keyword">var</span> val = ngmodel.$modelValue,<span class="comment">//获取input的值</span></div><div class="line">                        dataname = attrs.dataname;</div><div class="line">                    <span class="keyword">if</span> (val &amp;&amp; val != <span class="string">''</span>) &#123;<span class="comment">//当输入框不为空时，我们进入这个函数，然后进行过滤</span></div><div class="line">                        <span class="keyword">var</span> name = dataname.split(<span class="string">"."</span>);</div><div class="line">                        <span class="keyword">if</span> (val.length - startLen === <span class="number">2</span>) &#123;<span class="comment">//获取新输入的字符的的长度，因为Emoji常有的是四个字节，也就是两个字符，然后进行新加入的字符进行判断是否为Emoji</span></div><div class="line">                            <span class="keyword">var</span> test = val.substring(startLen, val.length)<span class="comment">//取到新输入的字符</span></div><div class="line">                            <span class="keyword">var</span> isEmoji = <span class="literal">false</span>;<span class="comment">//初始化状态</span></div><div class="line">                            <span class="built_in">escape</span>(test).replace(<span class="regexp">/\%uD/g</span>, <span class="function"><span class="keyword">function</span> (<span class="params">word</span>) </span>&#123;<span class="comment">//这里我们进行Emoji的特征匹配，如果符合我们就进行Unicode的值的判断</span></div><div class="line">                                isEmoji = <span class="literal">true</span></div><div class="line">                                <span class="keyword">return</span> <span class="string">''</span>;</div><div class="line">                            &#125;);</div><div class="line">                            <span class="keyword">if</span> (isEmoji) &#123;<span class="comment">//这里进行判断是否符合Emoji的特征</span></div><div class="line">                                <span class="keyword">var</span> H = test.charCodeAt(<span class="number">0</span>);<span class="comment">//取高位</span></div><div class="line">                                <span class="keyword">var</span> L = test.charCodeAt(<span class="number">1</span>);<span class="comment">//取低位</span></div><div class="line">                                <span class="keyword">var</span> utf16val = <span class="number">0x10000</span> + H + L;<span class="comment">//进行运算</span></div><div class="line">                                <span class="keyword">if</span> (utf16val &gt; <span class="number">0xFFFF</span>) &#123;<span class="comment">//判断是否在我们常用的编码范围内，上文中已经提到了</span></div><div class="line">                                    val = val.substring(<span class="number">0</span>, startLen)<span class="comment">//符合Emoji特征的话进行删除</span></div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        startLen = val.length;<span class="comment">//把值赋给初始状态</span></div><div class="line">                        <span class="keyword">var</span> val = <span class="built_in">unescape</span>(<span class="built_in">escape</span>(val).replace(<span class="regexp">/\%uD.&#123;3&#125;/g</span>, <span class="string">''</span>)).trim();<span class="comment">//下面就是进行一些正则进行替换掉符合Emoji的字符编码，由于各个平台以及输入法实现Emoji的方式不同，只能把所有符合Emoji状态的都删除，但是这样子带来的弊端就是有可能误删一些字符</span></div><div class="line">                      	val = val.replace(<span class="regexp">/\^\:[a-z0-9_]+\:$/</span>).trim();</div><div class="line">                        val = <span class="built_in">unescape</span>(<span class="built_in">escape</span>(val).replace(<span class="regexp">/\%u26.&#123;2&#125;/g</span>, <span class="string">''</span>).replace(<span class="regexp">/\%uE.&#123;3&#125;/g</span>, <span class="string">''</span>).replace(<span class="regexp">/\%u27.&#123;2&#125;/g</span>, <span class="string">''</span>).replace(<span class="regexp">/\%uFE0F/g</span>, <span class="string">''</span>).replace(<span class="regexp">/\%u2B50/g</span>, <span class="string">''</span>));</div><div class="line">                        val = val.replace(<span class="regexp">/\uD83C[\uDF00-\uDFFF]|\uD83D[\uDC00-\uDE4F]/g</span>, <span class="string">""</span>);</div><div class="line">                        val = <span class="built_in">unescape</span>(<span class="built_in">escape</span>(val).replace(<span class="regexp">/\%u0x0 - \%u0x10FFFF/g</span>, <span class="string">''</span>));</div><div class="line">                        <span class="keyword">var</span> ranges = [</div><div class="line">                            <span class="string">'\ud83c[\udf00-\udfff]'</span>,</div><div class="line">                            <span class="string">'\ud83d[\udc00-\ude4f]'</span>,</div><div class="line">                            <span class="string">'\ud83d[\ude80-\udeff]'</span></div><div class="line">                        ];</div><div class="line">                        val = val.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(ranges.join(<span class="string">'|'</span>), <span class="string">'g'</span>), <span class="string">''</span>);</div><div class="line">                        scope[name[<span class="number">0</span>]][name[<span class="number">1</span>]] = val.trim();</div><div class="line">                        scope.$apply();</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        startLen = <span class="number">0</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ]);</div></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2017/04/01/JavaScript/常用代码收集/" class="next">下一篇</a></div><div class="copyright"><p>© 2014 - 2017 <a href="https://github.com/xuhongbo" target="_blank">xuhongbo-github</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>